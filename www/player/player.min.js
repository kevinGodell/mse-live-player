'use strict';var _createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,'value'in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var VideoPlayer=function(){function a(b,c){var d=this;if(_classCallCheck(this,a),this._callback='function'==typeof c?c:function(k,l){return k?void console.error('VideoPlayer Error: '+k+' Namespace: '+d._namespace):void console.log('VideoPlayer Message: '+l+' Namespace: '+d._namespace)},!b.video||!(b.video instanceof HTMLVideoElement))return void this._callback('"options.video" is not a video element');if(!b.namespace)return void this._callback('missing "options.namespace"');if(!b.io||!b.io.hasOwnProperty('Socket'))return void this._callback('"options.io is not an instance of socket.io');if(this._video=b.video,b.controls){var e=-1!==b.controls.indexOf('startstop'),f=-1!==b.controls.indexOf('fullscreen'),g=-1!==b.controls.indexOf('snapshot'),h=-1!==b.controls.indexOf('cycle');if((e||f||g||h)&&(this._container=document.createElement('div'),this._container.className='mse-container',this._video.parentNode.replaceChild(this._container,this._video),this._video.className='mse-video',this._video.controls=!1,this._video.removeAttribute('controls'),this._container.appendChild(this._video),this._controls=document.createElement('div'),this._controls.className='mse-controls',this._container.appendChild(this._controls),e&&(this._startstop=document.createElement('button'),this._startstop.className='mse-start',this._startstop.addEventListener('click',function(){d.togglePlay()}),this._controls.appendChild(this._startstop)),f&&(this._fullscreen=document.createElement('button'),this._fullscreen.className='mse-fullscreen',this._fullscreen.addEventListener('click',function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():d._container.requestFullscreen?d._container.requestFullscreen():d._container.msRequestFullscreen?d._container.msRequestFullscreen():d._container.mozRequestFullScreen?d._container.mozRequestFullScreen():d._container.webkitRequestFullscreen&&d._container.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}),this._controls.appendChild(this._fullscreen)),g&&(this._snapshot=document.createElement('button'),this._snapshot.className='mse-snapshot',this._snapshot.addEventListener('click',function(){if(2>d._video.readyState)return void d._callback(null,'readyState: '+d._video.readyState+' < 2');var l=document.createElement('canvas');l.width=d._video.videoWidth,l.height=d._video.videoHeight;var m=l.getContext('2d');m.drawImage(d._video,0,0,l.width,l.height);var n=l.toDataURL('image/jpeg',1),o=document.createElement('a');o.href=n;new Date().getTime();o.download=d._namespace+'-'+new Date().getTime()+'-snapshot.jpeg',d._container.appendChild(o),o.click(),d._container.removeChild(o)}),this._controls.appendChild(this._snapshot)),h)){if(this._cycle=document.createElement('button'),this._cycle.className='mse-cycle',this._cycling=!1,b.cycleTime){var j=parseInt(b.cycleTime);this._cycleTime=2>j?2e3:10<j?1e4:1e3*j}else this._cycleTime=2e3;this._cycle.addEventListener('click',function(){if(!d._cycling){d._namespaces=[],d._cycleIndex=0;for(var l=window.videoPlayers,m=0;m<l.length;m++)d._namespaces.push(l[m].namespace),l[m]===d?d._cycleIndex=m:l[m].disabled=!0;if(2>d._namespaces.length)return d._callback(null,'unable to cycle because namespaces < 2'),delete d._namespaces,void delete d._cycleIndex;d._playing||d.start(),d._startstop&&d._startstop.classList.add('cycling'),d._cycle.classList.add('animated'),d._cycleInterval=setInterval(function(){d._cycleIndex++,d._cycleIndex===d._namespaces.length&&(d._cycleIndex=0),d.start(d._namespaces[d._cycleIndex])},d._cycleTime),d._cycling=!0}else{clearInterval(d._cycleInterval),d._cycle.classList.remove('animated'),d._startstop&&d._startstop.classList.remove('cycling'),d.start();for(var n=window.videoPlayers,o=0;o<n.length;o++)n[o]!==d&&(n[o].disabled=!1);delete d._namespaces,delete d._cycleInterval,d._cycling=!1}}),this._controls.appendChild(this._cycle)}}return this._namespace=b.namespace,this._io=b.io,window.videoPlayers||(window.videoPlayers=[]),window.videoPlayers.push(this),this}return _createClass(a,[{key:'mediaInfo',value:function mediaInfo(){var b='******************\n';b+='namespace : '+this._namespace+'\n',this._video&&(b+='video.paused : '+this._video.paused+'\nvideo.currentTime : '+this._video.currentTime+'\nvideo.src : '+this._video.src+'\n',this._sourceBuffer.buffered.length&&(b+='buffered.length : '+this._sourceBuffer.buffered.length+'\nbuffered.end(0) : '+this._sourceBuffer.buffered.end(0)+'\nbuffered.start(0) : '+this._sourceBuffer.buffered.start(0)+'\nbuffered size : '+(this._sourceBuffer.buffered.end(0)-this._sourceBuffer.buffered.start(0))+'\nlag : '+(this._sourceBuffer.buffered.end(0)-this._video.currentTime)+'\n')),b+='******************\n',console.info(b)}},{key:'togglePlay',value:function togglePlay(){return!0===this._playing?this.stop():this.start(),this}},{key:'start',value:function start(b){return b||(b=this._namespace),!0===this._playing&&this.stop(),this._startstop&&(this._startstop.classList.add('mse-stop'),this._startstop.classList.remove('mse-start'),this._startstop.disabled=!0),this._playing=!0,this._socket=this._io(location.origin+'/'+b,{transports:['websocket'],forceNew:!1}),this._addSocketEvents(),this._startstop&&(this._startstop.disabled=!1),this}},{key:'stop',value:function stop(){return this._startstop&&(this._startstop.classList.add('mse-start'),this._startstop.classList.remove('mse-stop'),this._startstop.disabled=!0),this._playing=!1,this._video&&(this._removeVideoEvents(),this._video.pause(),this._video.removeAttribute('src'),this._video.load()),this._socket&&(this._removeSocketEvents(),this._socket.connected&&this._socket.disconnect(),delete this._socket),this._mediaSource&&(this._removeMediaSourceEvents(),this._mediaSource.sourceBuffers&&this._mediaSource.sourceBuffers.length&&this._mediaSource.removeSourceBuffer(this._sourceBuffer),delete this._mediaSource),this._sourceBuffer&&(this._removeSourceBufferEvents(),this._sourceBuffer.updating&&this._sourceBuffer.abort(),delete this._sourceBuffer),this._startstop&&(this._startstop.disabled=!1),this}},{key:'destroy',value:function destroy(){return this}},{key:'_onVideoError',value:function _onVideoError(b){this._callback('video error '+b.type)}},{key:'_onVideoLoadedData',value:function _onVideoLoadedData(b){var c=this;this._callback(null,'video loaded data '+b.type),'Promise'in window?this._video.play().then(function(){}).catch(function(d){c._callback(d)}):this._video.play()}},{key:'_addVideoEvents',value:function _addVideoEvents(){this._video&&(this.onVideoError=this._onVideoError.bind(this),this._video.addEventListener('error',this.onVideoError,{capture:!0,passive:!0,once:!0}),this.onVideoLoadedData=this._onVideoLoadedData.bind(this),this._video.addEventListener('loadeddata',this.onVideoLoadedData,{capture:!0,passive:!0,once:!0}),this._callback(null,'added video events'))}},{key:'_removeVideoEvents',value:function _removeVideoEvents(){this._video&&(this._video.removeEventListener('error',this.onVideoError,{capture:!0,passive:!0,once:!0}),delete this.onVideoError,this._video.removeEventListener('loadeddata',this.onVideoLoadedData,{capture:!0,passive:!0,once:!0}),delete this.onVideoLoadedData,this._callback(null,'removed video events'))}},{key:'_onMediaSourceClose',value:function _onMediaSourceClose(b){this._callback(null,'media source close '+b.type)}},{key:'_onMediaSourceOpen',value:function _onMediaSourceOpen(){URL.revokeObjectURL(this._video.src),this._mediaSource.duration=Number.POSITIVE_INFINITY,this._sourceBuffer=this._mediaSource.addSourceBuffer(this._mime),this._sourceBuffer.mode='sequence',this._addSourceBufferEvents(),this._sourceBuffer.appendBuffer(this._init),this.onSegment=this._onSegment.bind(this),this._socket.addEventListener('segment',this.onSegment,{capture:!0,passive:!0,once:!1}),this._socket.send('segments')}},{key:'_addMediaSourceEvents',value:function _addMediaSourceEvents(){this._mediaSource&&(this.onMediaSourceClose=this._onMediaSourceClose.bind(this),this._mediaSource.addEventListener('sourceclose',this.onMediaSourceClose,{capture:!0,passive:!0,once:!0}),this.onMediaSourceOpen=this._onMediaSourceOpen.bind(this),this._mediaSource.addEventListener('sourceopen',this.onMediaSourceOpen,{capture:!0,passive:!0,once:!0}))}},{key:'_removeMediaSourceEvents',value:function _removeMediaSourceEvents(){this._mediaSource&&(this._mediaSource.removeEventListener('sourceclose',this.onMediaSourceClose,{capture:!0,passive:!0,once:!0}),delete this.onMediaSourceClose,this._mediaSource.removeEventListener('sourceopen',this.onMediaSourceOpen,{capture:!0,passive:!0,once:!0}),delete this.onMediaSourceOpen)}},{key:'_onSourceBufferError',value:function _onSourceBufferError(b){this._callback('sourceBufferError '+b.type)}},{key:'_onSourceBufferUpdateEnd',value:function _onSourceBufferUpdateEnd(){if(!this._sourceBuffer.updating){if(this._lastSegment)return this._sourceBuffer.appendBuffer(this._lastSegment),void delete this._lastSegment;if(this._sourceBuffer.buffered.length){var c=this._video.currentTime,d=this._sourceBuffer.buffered.start(0),e=this._sourceBuffer.buffered.end(0);20<c-d&&c<e&&this._sourceBuffer.remove(d,c-4)}}}},{key:'_addSourceBufferEvents',value:function _addSourceBufferEvents(){this._sourceBuffer&&(this.onSourceBufferError=this._onSourceBufferError.bind(this),this._sourceBuffer.addEventListener('error',this.onSourceBufferError,{capture:!0,passive:!0,once:!0}),this.onSourceBufferUpdateEnd=this._onSourceBufferUpdateEnd.bind(this),this._sourceBuffer.addEventListener('updateend',this.onSourceBufferUpdateEnd,{capture:!0,passive:!0,once:!1}))}},{key:'_removeSourceBufferEvents',value:function _removeSourceBufferEvents(){this._sourceBuffer&&(this._sourceBuffer.removeEventListener('error',this.onSourceBufferError,{capture:!0,passive:!0,once:!0}),delete this.onSourceBufferError,this._sourceBuffer.removeEventListener('updateend',this.onSourceBufferUpdateEnd,{capture:!0,passive:!0,once:!1}),delete this.onSourceBufferUpdateEnd)}},{key:'_onSocketConnect',value:function _onSocketConnect(){this.onMime=this._onMime.bind(this),this._socket.addEventListener('mime',this.onMime,{capture:!0,passive:!0,once:!0}),this._socket.send('mime')}},{key:'_onSocketDisconnect',value:function _onSocketDisconnect(b){this._callback(null,'socket disconnect "'+b+'"'),this.stop()}},{key:'_onSocketError',value:function _onSocketError(b){this._callback('socket error "'+b+'"'),this.stop()}},{key:'_onMime',value:function _onMime(b){return this._mime=b,MediaSource.isTypeSupported(this._mime)?void(this.onInit=this._onInit.bind(this),this._socket.addEventListener('initialization',this.onInit,{capture:!0,passive:!0,once:!0}),this._socket.send('initialization')):(this._video.setAttribute('poster','data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjM0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxnPjxyZWN0IHg9Ii0xIiB5PSItMSIgd2lkdGg9IjY0MiIgaGVpZ2h0PSIzNiIgZmlsbD0ibm9uZSIvPjwvZz48Zz48dGV4dCBmaWxsPSIjMDAwIiBzdHJva2Utd2lkdGg9IjAiIHg9IjE3NyIgeT0iMjYiIGZvbnQtc2l6ZT0iMjYiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmIiB0ZXh0LWFuY2hvcj0ic3RhcnQiIHhtbDpzcGFjZT0icHJlc2VydmUiIHN0cm9rZT0iIzAwMCI+bWltZSB0eXBlIG5vdCBzdXBwb3J0ZWQ8L3RleHQ+PC9nPjwvc3ZnPg=='),void this._callback('unsupported mime "'+this._mime+'"'))}},{key:'_onInit',value:function _onInit(b){this._init=b,this._mediaSource=new MediaSource,this._addMediaSourceEvents(),this._addVideoEvents(),this._video.src=URL.createObjectURL(this._mediaSource)}},{key:'_onSegment',value:function _onSegment(b){if(this._sourceBuffer.buffered.length){var c=this._sourceBuffer.buffered.end(0)-this._video.currentTime;0.5<c&&(this._video.currentTime=this._sourceBuffer.buffered.end(0)-0.5)}this._sourceBuffer.updating?this._lastSegment=b:(delete this._lastSegment,this._sourceBuffer.appendBuffer(b))}},{key:'_addSocketEvents',value:function _addSocketEvents(){this._socket&&(this.onSocketConnect=this._onSocketConnect.bind(this),this._socket.addEventListener('connect',this.onSocketConnect,{capture:!0,passive:!0,once:!0}),this.onSocketDisconnect=this._onSocketDisconnect.bind(this),this._socket.addEventListener('disconnect',this.onSocketDisconnect,{capture:!0,passive:!0,once:!0}),this.onSocketError=this._onSocketError.bind(this),this._socket.addEventListener('error',this.onSocketError,{capture:!0,passive:!0,once:!0}))}},{key:'_removeSocketEvents',value:function _removeSocketEvents(){this._socket&&(this._socket.removeEventListener('connect',this.onSocketConnect,{capture:!0,passive:!0,once:!0}),delete this.onSocketConnect,this._socket.removeEventListener('disconnect',this.onSocketDisconnect,{capture:!0,passive:!0,once:!0}),delete this.onSocketDisconnect,this._socket.removeEventListener('error',this.onSocketError,{capture:!0,passive:!0,once:!0}),delete this.onSocketError,this._socket.removeEventListener('mime',this.onMime,{capture:!0,passive:!0,once:!0}),delete this.onMime,this._socket.removeEventListener('initialization',this.onInit,{capture:!0,passive:!0,once:!0}),delete this.onInit,this._socket.removeEventListener('segment',this.onSegment,{capture:!0,passive:!0,once:!1}),delete this.onSegment)}},{key:'namespace',get:function get(){return this._namespace||null},set:function set(b){this._namespace=b}},{key:'disabled',get:function get(){return!!this._container&&this._container.classList.contains('disabled')},set:function set(b){if(this._container)if(!0===b){if(this._container.classList.contains('disabled'))return;this._container.classList.add('disabled'),this.stop()}else{if(!this._container.classList.contains('disabled'))return;this._container.classList.remove('disabled'),this.start()}}}]),a}();(function(b){if(!('io'in b))throw new Error('socket.io was not found');for(var e,c=document.getElementsByTagName('video'),d=0;d<c.length;d++)if(e=c[d],e.dataset.namespace){var f=new VideoPlayer({video:e,io:io,namespace:e.dataset.namespace,controls:e.dataset.controls});e.autoplay&&f.start()}})(window);